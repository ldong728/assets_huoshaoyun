<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no" />
	<title>产品详情</title>
	<link href="../css/main.css" rel="stylesheet">
	<script type="text/javascript" src="../js/jquery.min.js"></script>
	<script type="text/javascript" src="../js/main.js"></script>
	<script type="text/javascript" src="../js/template.js"></script>
    <style>
        .popup{position: absolute;left: 0;bottom: 0; width: 100%;height: 70vh;padding: 0 10px;box-sizing: border-box; background-color: #f3f3f3;z-index: 299;display: none;}
        .popupTop,.popupMiddle_two,.popupMiddle_bottom,.popupButton,.popupTop_left,.popupBottom_num,.popupBottom_btn{display: -webkit-flex; /* Safari */display: flex;}
        .popupTop{position: absolute;top: 0;left: 0; height: 85px; width: 100%;}
        .popupTop_left{width: 105px;height: 100px; margin-top: -15px;margin-left: 10px;}
        .popupTop_left img{width: 100%;height: 100%;border: 3px solid #fff;border-radius: 6px;box-sizing: border-box;overflow: hidden;}
        .popupTop_right{width: calc(100% - 100px);line-height: 1.2em; padding: 0 10px; box-sizing: border-box;font-size: 12px;}
        .popupTop_right p{padding: 5px 0;}
        .popupTop_right p.red{padding-top: 10px;  font-size: 15px;box-sizing: border-box;}
        .popupTop p span{margin-top: 8px;margin-right: 5px;padding-left: 0;}
        .popupTop_close{position: absolute;right: 10px;width: 20px;height: 20px;margin-top:10px;font-size: 16px;  color: #666;border: 2px solid #666;text-align: center;line-height: 22px;border-radius: 50%;}
        .popupMiddle .li{margin-top: 20px;}
        .popupMiddle .li h4{font-weight: normal;font-size: 14px;margin-bottom: 5px;}
        .popupMiddle .li p{font-size: 12px;}
        .popupMiddle .li p span{display: inline-flex;margin-top: 10px; margin-right: 10px;padding: 5px 10px; background-color: #fff;border-radius: 3px;}
        .popupMiddle_bottom{margin-top: 30px;margin-bottom: 15px; height: 30px;line-height: 30px;}
        .popupBottom_num,.popupBottom_btn{width: 50%;font-size: 14px;}
        .popupBottom_btn{font-size: 14px;justify-content: flex-end;}
        .popupBottom_btn span{width: 40px;height: 30px;background-color: #fff;text-align: center;}
        .popupBottom_btn span i{color: #999;}
        .popupBottom_btn span.num{background-color: #f3f3f3!important;font-size: 16px;}
        .popupButton{position: absolute;bottom: 0;left: 0;width: 100%;}
        .popupButton button{width: 50%;height: 40px;color: #fff;font-size: 14px}
        .popupButton button:first-child{background-color: #ffdd00;border: 1px solid #fd0;}
        .popupButton button:last-child{background-color: #ff6800;border: 1px solid #ff6800;}
        .popupMiddle_auto{height: calc(70vh - 125px); overflow: auto;}
        .liCur{background-color: #ff6800!important;color: #fff;}
        .disabled{color: #636363
        }
		.itemIMGBox{
			width: 100%;
		}
    </style>

</head>


<body class="gray">

<div id="template_header"></div>

<div id="template_body">
	<div class="g-detail flex flex-center">
        <div class="itemIMGBox"><img class="img item-img" src="../images/4.jpg"></div>
	</div>
	<section>
		<div class="container">
			<div class="row bg-magin magin-b5" style="padding:15px;">
				<p class="height40 red h3">￥<i id="item-price">7999</i></p>
				<p class="h4 lineheight12" id="item-desc">Adidas阿迪达斯男女鞋Yeezy 350 v2 Boost纯白侃爷椰子运动鞋</p>
				<!--<div class="gray height40 de-comment">-->
					<!--<div class="left">-->
						<!--<i class="icon icon-star yellow"></i>-->
						<!--<i class="icon icon-star yellow"></i>-->
						<!--<i class="icon icon-star yellow"></i>-->
						<!--<i class="icon icon-star yellow"></i>-->
						<!--<i class="icon icon-star-half-empty yellow"></i>-->
						<!--<span class="yellow"> 4.7分</span>-->
					<!--</div>-->
					<!--<div class="right color6">销量 4521</div>-->
				<!--</div>-->
			</div>
			<div class="row bg-magin detail-message magin-b5">
                <p class="gdChoose choose-js" style="font-size: 13px;color: #000;line-height: 40px;">选择规格<i class="icon icon-angle-right" style="float: right;height: 40px;width: 12%;font-size: 24px;text-align: center;line-height: 40px;margin-right: -15px;"></i></p>
			</div>
			<div class="row bg-magin magin-b5 padding-bottom15">
				<h4 class="h4 height50 c-all">其他小伙伴们说（2345）<i class="icon icon-angle-right"></i></h4>
				<div class="cm-txt">
					<!--<div class="cm-t-t clearfix">-->
						<!--<p class="p1"><img src="../images/p-2.png"></p>-->
						<!--<p class="p2">天*****屎</p>-->
					<!--</div>-->
					<p class="c-all-text" id="item-comment">鞋子的底很软，有支撑，不系鞋带也跟脚，鞋子很透气，夏天穿也不会闷脚，穿白色特别有精神，喜欢！！！</p>
				</div>
			</div>
			<div class="row bg-magin border-bottom" id="detail-content">
				<ul class="g-d-main clearfix">
					<li><i class="icon icon-angle-left"></i></li>
					<li><a href="#">商品</a></li>
					<li><a href="#">评价</a></li>
					<li><a href="#" class="a-cur">详情</a></li>
					<li><i class="icon icon-shopping-cart"></i></li>
				</ul>
				<div class="img-detail">
					<p class="size16">图文详情</p>
					<div class="bg-magin padding-none">
						<img src="../images/未标题-5.jpg">
					</div>
					<div class="g-d-m">
						<p><span>产品<br>信息</span></p>
						<div class="d-m-t">
							<table width="100%" border="0" cellpadding="0" cellspacing="0">
								<tbody>
									<tr>
										<td>品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</td>
										<td>Yeezy Boost 350 V2 侃爷椰子跑鞋</td>
									</tr>
									<tr>
										<td>颜&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;色：</td>
										<td>淡米白</td>
									</tr>
									<tr>
										<td>鞋面材质：</td>
										<td>织物</td>
									</tr>
									<tr>
										<td>鞋底材质：</td>
										<td>橡胶</td>
									</tr>
									<tr>
										<td>产&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;地：</td>
										<td>中国（不同批次产地可能有所不同，请以实物为准）</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

		</div>
	</section>
</div>

<div id="template_footer"></div>
<div class="popup sku-js">
    <div class="popupTop">
        <div class="clearfix popupTop_left flex flex-center">
			<div class="itemIMGBox">
				<img class="item-img" src="../images/123.jpg">
			</div>
        </div>
        <div class="clearfix popupTop_right">
            <p class="red">￥<i class="sku-price">29</i></p >
            <p>库存<i class="sku-num">7703</i>件</p >
            <p class="three selected-display"></p >
        </div>
        <div class="popupTop_close close-sku-selector">
            <i class="icon icon-close"></i>
        </div>
    </div>
    <div class="popupMiddle">
        <div style="height: 85px;"></div>
        <div class="popupMiddle_auto properties-container">
            <div class="li parent-element">
                <h4 class="parent-name"></h4>
                <p class="parent-container">
                    <span class="sub-element sku-option"></span>


                </p >

            </div>
            <div class="popupMiddle_bottom">
                <div class="popupBottom_num">购买数量</div>
                <div class="popupBottom_btn">
                    <span><i class="icon icon-minus buy-num-change num-minus"></i></span>
                    <span class="num buy-num">5</span>
                    <span><i class="icon icon-plus buy-num-change num-plus"></i></span>
                </div>
            </div>
        </div>
    </div>

    <div class="popupButton">
        <button type="button" class="buy-button add-to-cart">加入购物车</button>
        <button type="button" class="buy-button buy-now">立即购买</button>
    </div>
</div>
<script>
    var id,type,fromPage,elementList,selected,skus,properties,propertiesNum,sku;

    $(document).ready(function(){
        Templates.loadTemplates('goodsDetail','商品详情');
        setInitParam();
        registerClickEvent();
        resizeBody();
        scrollWatcher(null,null);
//        id=25;
        app('item_detail',{item_id:id});
        app('itemcomment_list',{item_id:id});

    });

    function resizeBody() {
        var body = $('#template_body');
        body.children()[0].remove();
        var totalHeight = window.screen.height;
        console.log(totalHeight);
        var footerHeight = $('#template_footer').height();
        var headerHeight = $('#template_header').height();
        body.height(totalHeight-footerHeight);
        body.css('top',0);
    }

    function setInitParam() {
        id=getUrlParam('itemId');
        type=getUrlParam('type');
        fromPage=getUrlParam('fromPage');
        if(!fromPage){
            fromPage = 'index';
        }

        elementList=prepareElement('.parent-element','.sub-element');
        selected={};
        skus=false;
        properties={};
        propertiesNum=0;
        sku=false;
    }

    function registerClickEvent() {
        $(document).on('click','.header-back',function () {
            header(fromPage);
        });
        $(document).on('click','.header-cart',function () {
            header('shopCart');
        });
        $(document).on('click','.choose-js',function(){
            $('.sku-js').show();
//            if(!skus||!properties){
//                initSkuSelector(data);
//            }

        });
        $(document).on('click','.sku-option',function(){
            var id=$(this).attr('id');
            var parentId=$(this).parent().data('id');
           if($(this).hasClass('disabled')){
               return;
           } else{
               if($(this).hasClass('liCur')){
                   setSkuStatus(parentId,id,false);
                   $(this).removeClass('liCur');
               }else{
                   setSkuStatus(parentId,id,true);
                   $('.group'+parentId).removeClass('liCur');
                   $(this).addClass('liCur');
               }
               refreshPropertyTag();
           }
        });

        $(document).on('click','.buy-button',function(){
            if(!sku){
                alert('请选择详细分类');
                return;
            }
           if($(this).hasClass('add-to-cart')){
               var data={'item_id':id,'sku_id':sku.id,'num':parseInt($('.buy-num').text())};
               console.log(data);
                app('cart_modify',data);
           }else{
               var data={items:[{sku_id:sku.id,num:parseInt($('.buy-num').text()),item_id:id}]};
               app('order_pre_order',data);
           }
        });
        $(document).on('click','.buy-num-change',function(){
            if(!sku){
                alert('请选择详细分类');
                return;
            }
            var currentNum=parseInt($('.buy-num').text());
            var maxNum=parseInt(sku.num);
            if($(this).hasClass('num-minus')){
                if(currentNum>1)$('.buy-num').text(--currentNum);
            }else{
                if(currentNum<maxNum)$('.buy-num').text(++currentNum);
            }
        });
        $(document).on('click','.close-sku-selector',function(){
           $('.sku-js').hide();
        });
    }

    function callback_jsonCallback(back) {
        var backValue = handleBack(back);
        console.log(backValue);
        if(backValue['success'] == false){
            console.log('callback ERR: '+backValue['message']);
            return;
        }
        switch (backValue['callback']) {
			case 'item_detail':
                console.log(backValue['data']);
                app('item_skus',{pid:backValue['data']["pid"]});
               	initItemInf(backValue['data']);
                break;
            case 'item_skus':
               	initSkuSelector(backValue['data']);
                break;
            case 'cart_modify':
                alert('已加入购物车');
                break;
            case 'order_pre_order':
                var preOrderId=backValue.data.pre_order_ids;
//                console.log(preOrderId);
                header('orderBy',{preOrderIds:preOrderId});
                break;
            case 'itemcomment_list':
                initComment(backValue['data']);
                break;
            default :

                break;
        }
    }
    var pcontent;
    function callback_getContent(data){
        pcontent = data;
        var content;
        if(data instanceof Object){
            content = data.content;
            $('#detail-content').html(content);
        }else{
            content = data.slice(12,-2);
            $('#detail-content').html(content);
        }
    }
    function initItemInf(data){
        console.log(data);
        $('.item-img').attr('src',data.img);
        $('#item-desc').text(data.desc);
        $('#item-price').text(disPlayPrice(data.show_price));
    }
    function initComment(data){
        var content=data.comments;
        content=content?content[0].content:'';
        $('#item-comment').text(content);
    }
    function initSkuSelector(data){
//        properties=data.properties;
        properties={};
        skus={};
        if(data.properties.length>0){
            propertiesNum=data.properties.length;

            $.each(data.properties,function(kp,vp){
                var parentElement=elementList['.parent-element'].clone();
                parentElement.find('.parent-name').text(vp.name);
                parentElement.find('.parent-name').attr('id','pro'+vp.id);
                var parentContainer=parentElement.find('.parent-container');
                parentContainer.attr('data-id',vp.id);
                parentContainer.empty();
                properties[vp.id]={id:vp.id,name:vp.name,values:{}};
//                properties[vp.id].values={};
				console.log(vp);
                $.each(vp.values,function(ks,vs){
                    properties[vp.id].values[vs.id]=vs.name;
                    var subElement=elementList['.sub-element'].clone();
                    subElement.text(vs.name);
                    subElement.addClass('group'+vp.id);
                    subElement.attr('id',vs.id);
                    parentContainer.append(subElement);
                });
                $('.properties-container').append(parentElement);
            });
            $.each(data.skus,function(k,v){
                v.array= v.values.split('_');
                v.array.shift();
                skus[v.values]=v;
            });
        }else{//无分类
            sku=data.skus;
            var parentElement=elementList['.parent-element'].clone();
            parentElement.find('.parent-name').text('规格选择');
            var parentContainer=parentElement.find('.parent-container');
            var subElement=elementList['.sub-element'].clone();
            subElement.text('默认');
            subElement.removeClass('sku-option');
            subElement.addClass('liCur');
            parentContainer.append(subElement);
            $('.properties-container').append(parentElement);
        }

    }
    function setSkuStatus(parentId,id,choose){
        if(choose){
            selected[parentId]=id;
        }
        else{
            delete selected[parentId]
        }
//        if(selected[parentId]){
//        var deleteFlag=false;
        var selectArray=[];
        var selectStr=[];
        console.log(selected);
        $.each(selected,function(k,v){
//            console.log(k,v);
//            if(deleteFlag){
//                delete selected[k];
//            }else{
                selectArray.push(v);
//            }
//            if(k==parentId){
//                console.log('in delete','key:'+k,'parentId:'+parentId,'id:'+id,'choose:'+choose);
//                deleteFlag=true;
//            }
        });

//        }

        console.log(selectArray);
        selectArray.sort();
        selectStr=selectArray.join('.*');
        console.log(selectStr);
        var enableList=[];
        var patten=new RegExp(selectStr);
        var matchList=[];
//        console.log(skus);
        $.each(skus,function(k,v){
            if(k.match(patten)&& parseInt(v.num)>0){
                console.log(k);
                matchList.push(v);
                $.each(v.array,function(k2,id){
                    if(enableList.indexOf(id)<0)enableList.push(id);
                });
            }
        });
//        console.log(matchList);
//        console.log(enableList.sort());
        if(1==matchList.length)sku=matchList[0];
        else sku=false;
        //显示结果
        var displaySku=sku||matchList[0];
        $('.sku-option').each(function(k,v){
            var id= v.id;


            if(enableList.indexOf(id)>-1){
                $(v).removeClass('disabled');
//                if(parentId==$(v).parent().data('id'))return;
            }
            else{
                if(parentId==$(v).parent().data('id'))return;
                $(v).removeClass('liCur');
                $(v).addClass('disabled');
            }
        });
        $('.selected-display').empty();
//        $.each(selected,function(k,v){
//            console.log(properties[k]);
//            $('.selected-display').append('<span>'+properties[k].values[v]+'</span>')
//        });
//		console.log(displaySku);
        $('.sku-price').text(disPlayPrice(displaySku.normal_price));

        $('.sku-num').text(displaySku.num);
        if(parseInt($('.buy-num').text())>displaySku.num)$('.buy-num').text(displaySku.num);
//        console.log(selected);
    }

    function refreshPropertyTag() {
        var selected = $('.properties-container').find('.liCur');
        var container = $('.selected-display');
        container.empty();
        $.each(selected,function (k,v) {
//			console.log($(v).text());
            container.append('<span>'+$(v).text()+'</span>')
        });
    }


</script>

</body>
</html>
